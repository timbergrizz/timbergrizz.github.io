---
title: K8s - Best Practices
feed: hide
---

## Best Practices
- 구글 클라우드 기준인데, 다른 클라우드에도 유사한 기능이 있다.
- 여러 존에 걸쳐 배포할 수 있어야 한다.
	- 하나의 존에 풀을 몰빵하시면 안된다. 카카오!
- VPC-native Cluster
	- Cluster IP를 쓰는데, 이걸 써서 ip를 설정하곤 한다.
	- 쿠버네티스 IP 쓰는게 아니라 cloud vpc 부르도록 한다.
		- pod 부르는게 자연스러워진다.
	- 이 구조를 사용하지 않으면 NAT를 설치해야 하기 때문에 네트워크 구조가 복잡해질 수 있다.
	- 클러스터 크게 배포하면, 노드 수가 30만개까지 될 수 있다.
		- VPC 개수가 모자라질 수 있다.
- Node Auto-scaling
	- 당연히 해야 하는 것이다.
- Auto-upgrade / Auto-repair
	- repair는 pod 죽으면 다시 살려주는거다
	- upgrade는 dependency 같은거 꼬일 수 있다.
		- 운영을 할 때 항상 최신버전으로 운영하는 것이 좋은 것은 아닏
- Node의 OS도 굉장히 중요하다.
	- 보안적인 면도 굉장히 중요하고, 그래서 Node의 이미지를 잘 고를 수 있어야 한다.
	- COS라는 쿠베 전용 런타임 이미지를 만들었다.
		- 컨테이너 런타임에 최적화 / 자동 보안 패치 등이 이루어져 있다.
		- 특정 feature등에 대비해 ubuntu도 발생한다고 할 수 있다.
- node os를 최대한 가볍게 가져하고, shared file access를 쿠베 밖에 설계해 두는 것이 좋다.
	- 복잡도를 낮추기 위해서 밖에 두는 것이 좋다.
- Container image를 repo에 배포하면, 다운로드가 이루어진다.
	- 로컬에서 압축을 풀고, 캐싱이 되면 컨테이너가 작동하게 된다.
	- container의 start up time이 중요하고, 이를 위한 여러가지 테크닉이 있다.
		- node image 구울 때 캐싱을 박아놓고 굽는다.
	- 이러한 시나리오는 ML 모델이 큰 경우 발생할 수 있다.
	- 구글 클라우드는 image streaming 테크닉으로 repo에서 로컬에 캐싱된 이미지를 보고 fuse로 이미지를 읽어오면서 올린다.
		- 레이어 순서대로 읽어 오면서 올리고, 그래서 빠르게 작동한다.
	- 이거 올리는 속도는 최대한 빨리 만들도록 한다.
- Load Balancer 쓸 때, 클라우드 벤더에서 제공하는거 쓰는게 좋다.
	- native 쓰는것보다 DDoS 보호 등에서 좋다.
- NodeLocal DNS Cache
	- 쿠베는 서비스 만들면 dns name이 붙는다.
	- 일반적인 구조에서는 문제가 없는데, 노드가 많아지면 신나는거다.
		- 쿼리 퍼포먼스를 못버텨낸다.
	- 이를 해결할 수 있는 방법이 local dns를 사용하는 것이다.
		- 이를 통해 부담을 덜 수 있긴 한데, 좋은 방법은 아니다.
		- 클라우드 DNS에 integration을 이루는게 더 좋다.
- IP Address 배치하는거
	- 구글은 노드마다 256개까지 배치하도록 된다.
	- 큰 회사에서 IP 주소 부족한거지, 프로젝트에서는 이거 신경 쓸 필요 없다.
- 모니터링 로깅은 다세요...
- Ingress / Service 당연히 써야 한다.
- container-native LB
	- 쿠버네티스 서비스에서 트래픽이 들어오면 아무 노드로나 간다.
		- pod의 주소가 안보이고, 노드로 구성되기 때문이다.
		- 노드에서 팟으로 다시 라우팅 한다.
	- NEG라는 기능을 통해 pod로 바로 라우팅 할 수 있다.
- AutoPilot
	- 노드는 자동 매니지가 안되고, vm 단위로 계약되는데, 오토파일럿은 노드로 접근까지 안된다.
	- pod단위로 사용을 계산하고,  비용적으로 메리트가 있다.
	- node 단위의 마이크로한 조정이 어렵다.
	- 오토스케일의 overload가 없어져서 좋다.
- Backup
	- 스냅샷 잘 뜨시고, yaml만 잘 유지하면 어플리케이션 이미지는 잘 유지된다.
	- stateful set들은 중요하게 백업되어야 하고, 전략 잘 가져가야 한다.

##  Kubernetes Configuartion
- 일반적인 쿠베에 대한 내용이다.
- beta 버전 쓰지 말고, Stable API Version 쓰세요.
	- 알파나 베타 버전 쓰시면 신나집니다.
	- 구조 바뀌는 경우가 만핟.
- cnfig는 명령으로 하지 말고 항상 yaml based로 만들어라.
- naked pod으로 쓰지 마라.
	- replica set이나 deployment 안묶여 있는거 쓰지 마라
- label 전략 잘 써라.
	- 여기에 버전 정보를 넣는 경우도 있다.
	- 이건 굉장히 중요한 내용이다.
- deployment 쓸 때, record 쓰면 롤백이 된다.
	- 롤백 되는거 확인해라
- latest / no tag 쓰지 마세요.
	- 그냥 가져와서 쓰는거 별로 좋지 않은 practice이다.
	- 컨테이너를 업데이트해도 리포를 모른다.
		- 태그 이름이 같기 때문에 같은 이미지로 가정한다.
	- skaffold같은 툴 써서 커버할 수 있다.
- 컨테이너 올라올 때 마다 새로운 태그 올리도록 해야한다.
	- 버전 넘버 쓰는것도 좋고, commit number 써도 좋다.
- request / limit
	- CPU등 자원 양 명시해주는게 overcommited status 피하는데 도움이 된다 .
		- 필요로 하는 자원이 가용 자원보다 큰 상황.
- Readiness랑 liveness 사용하세요

## Container Image
- 베이스 이미지 가볍게 만드는거 중요하다.
	- alphine이나 slim 붙는 이미지가 있다.
		- 이런게 가볍다.
		- 구글에서 쓰는 데비안은 더 가볍다. 베이스는 이런거 써라.
	- security hazard 없는 것 사용해야 한다.
		- security를 보장할 수 있는거 써야 한다.
	- 무조건 official image 사용해라.
- Jib같은 걸 이용해서 jar integration하는 것이 좋다.
- 이미지의 점 문제 찾아주는 솔루션 있다. [sysdig](https://sysdig.com/blog/docker-image-scanning/](https://sysdig.com/blog/docker-image-scanning/))
	- 스캐닝의 기준이 리눅스 os 레벨의 문제고,  어플리케이션이나 미들웨어 단의 문제는 스캔이 안된다.
	- 툴을 돌리면 취약점이 엄청나게 나올 것이다.
		- 도커 이미지 업그레이드 속도가 느리기 때문에, 엄청나게 나올 것이고 다 잡을 수 없을 것이다.
			- critical만 꼭 잡도록 하면 된다.
- binary authorization은 쿠번네티스 기능이다.
	- signing 안 된 이미지는 배포를 할 수 없도록 하고, 배포하려면 인증을 받아야 한다.
		- 검증된 이미지만 배포할 수 있도록 하는 것이다.
	- DevOps에서 굉장히 중요한 기능이다.
- 검증된 보안 이미지에 대한 가이던스를 갖고 있어, 좋다.

## Workload
- 어플리케이션에서 필수적으로 해야 하는 것
	- liveness / probe 만들어 줘야 한다.
- logging은 json으로 하는 것이 좋다.
	- 로그 파싱하기도 좋고 분석하기도 좋다.
	- 에러 메시지만 보는것이 아니라, 데이터 파이프라인에도 사용되어서 형식 맞춰주는게 좋다.
- cloud code 곡 써라...

## Cost Optimization
- usage metering
	- 보통은 vm 단위로 측정되는데, SaaS 만들면 어떻게 측정할거임?
		- 포드 단위로 측정할 수 있어야 한다.
	- 구글의 경우 expose하면 빅쿼리로 들어간다.
		- sql query로 분석한다.
- cost optimization은 사용량을 볼 수 있고, 이를 바탕으로 사용량을 최적화할 수 있다.
- VM 타입 잘 골라야 한다.
	- E2가 N1보다 30% 싸다.
		- CPU 클럭 차이 나서 니즈 확인하고 필요에 따라 사용하도록 할 수 있어야 한다.
	- PVM
		- 연속 기능으로, 가용 보장 없이 저렴하게 사용할 수 있는 것들이 있다.
		- API 서버는 이렇게 쓰면 가격 절약할 수 있어서 좋다.
		- ML은 비용을 50%까지 줄일 수 있다.
			- 이거 체크포인트 만들어서 죽어도 다시 시작할 수 있도록 하면 된다.

## Security
- 컨테이너 루트 파일시스템은 readonly로
- 루트로 작동시키지 마라
- 권한 상승 쓰지 마라.
	- 근데 이거 어플리케이션 동작 안할수도 있어서 추천하지 않는다.
	- 시스템 콜 타고 들어가서, 이것때문에 문제 생길 수 있다.
- 네트워크 정책 쓰면 좋은데 의무적이지는 않다.
	- VPC 방화벽 쓰면 쿠버네티스 자체 방화벽 필요 없어진다.
- node에서 직접 접근 못하게 막아야 한다.
- gVisor같은 커널 보안 솔루션 쓰면 좋은데, 이건 엔터프라이즈급
- Authorised Network
	- Kubectl 마음대로 못하게 하는 것
- private cluster를 사용한다.
	- node를 expose시키는거 나쁜 practice
- GKE는 자동으로 master ip 바꿔주는 기능 있다.
	- 원치 않는 시스템 셧다운 발생할 수 있다.
	- credential 바뀌는 기능도 발생할 수 있다.
- 방화벽 써라.
