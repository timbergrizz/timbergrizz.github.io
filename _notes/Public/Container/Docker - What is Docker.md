# 도커란

## 컨테이너

-   컨테이너 : 격리된 환경에서 작동하는 프로세스
    -   리눅스 커널의 여러 기술 활용
    -   하드웨어 가상화 기술보다 가볍다.
    -   이미지 단위로 프로세스 실행 환경을 구성한다.
-   결론적으로 프로세서를 격리시켜주는 기술이라 할 수 있다.

## VM vs Docker

-   도커와 VM은 격리 대상이 다르다.
    -   VM은 OS 자체를 격리하고, 컨테이너는 프로세스 자체만을 격리한다.
        -   OS는 미니멀 버전을 설치해도 많은 프로세스들을 필요로 한다.
    -   컨테이너를 이용해 백그라운드에서 돌고 있는 OS의 오버헤드를 줄일 수 있다.
    -   도커는 구동하기 위해 필요한 라이브러리와 바이너리만 사용하는 것이 특징이다.
        -   내 프로그램에 필요한 환경만 구성하게 된다.
        -   반드시 필요한 것만 올려야 한다.
-   도커 엔진만 있으면 어떤 OS도 기동될 수 있다.
    -   호스트의 커널을 활용한다. 따라서 실 서비스에서 기동할때는 반드시 리눅스 커널에서 이용해야 한다.
-   최근에는 기존의 기술을 조합해 새로운 오픈 소스를 만들어내는 것이 많다.

## 도커의 특징

-   확장성
    -   도커 엔진만 설치되어 있으면 어디서든 컨테이너를 실행할 수 있다.
        -   동작 자체는 다를 수 있지만, 동작되는 과정은 동일하다.
    -   특정 회사나 서비스에 종속적이지 않다.
    -   쉽게 개발서버를 만들 수 있고 테스트 서버도 간편하게 사용할 수 있다.
-   표준성
    -   도커를 사용하지 않는 경우 다른 언어로 만든 서비스들은 배포 방식도 달라지게 된다.
    -   컨테이너라는 표준으로 서버를 배포하여 모든 서비스들의 배포 과정이 동일해진다.
    -   별도의 이미지 저장소에 배포를 저장하고 이미지를 교체하는 방식으로 실행해야 한다.
-   이미지
    -   클라우드에서 서버의 스냅샷을 통해 이미지를 만들고, 이를 통해 새로운 서비스를 만들 수 있다.
        -   클라우드의 가상화 이미지는 구동은 해볼수 있지만, 이미지가 어떻게 만들어져 있는지 알 수 없다.
        -   도커는 이미지를 도커파일로 정의하기 때문에 처음부터 재현 가능하고, 어떻게 만들어졌는지 알 수 있다.
    -   이미지에서 컨테이너를 생성하기 때문에 반드시 이미지를 만드는 과정이 필요하다.
    -   별도의 이미지 저장소에 저장하고 운영 서버에서 이미지를 불러오는 방식으로 실행한다.
-   설정
    -   설정을 환경 변수로 제어할 수 있다.
    -   MYSQL_PASS=password처럼 컨테이너를 띄울 때 환경변수를 같이 지정할 수 있다.
    -   하나의 이미지가 환경변수에 따라 동적으로 설정 파일을 생성하도록 만들어야 한다.
        -   서버에 대한 설정이 환경변수로 노출되어 있기 때문에 편하다.
-   자원
    -   컨테이너는 삭제 후 새로 만들면 모든 데이터가 초기화된다.
    -   도커 자체는 결국 프로세스. 프로세스가 죽으면 해당 컨테이너에 접근할 수 있다.
        -   죽으면 컨테이너 안의 데이터는 복구할 수 없다.
        -   도커 엔진은 도커 이미지를 프로세스로 격리할 때 격리되는 공간이 존재한다. 따라서 접근이 불가능하다.
        -   따라서, 컨테이너가 언제든 터질수 있다는 가정 하에서 아키텍처를 구성해야 한다.
            -   외부 저장소와 마운트할 수 있는 기능이 존재하고, 따라서 성격에 따라서 어떻게 관리할지도 설계해야 한다.
-   도커가 가져온 변화
    -   PaaS와 같은 제한이 없다.
        -   자동으로 서버를 관리해주기 때문에 서버의 상태를 고객을 변경할 수 없도록 한다.
    -   클라우드 이미지보다 관리하기 쉽다.
    -   다른 프로세스와 격리되어 가상머신처럼 사용하지만 성능 저하가 거의 없다.
    -   커널 단위의 기술을 몰라도 사용은 할 수 있다.
    -   이미지를 정의할 때 빌드 기록이 남는다.
    -   코드와 설정으로 관리되기 때문에, 재현과 수정이 가능하다.
    -   오픈 소스이기 때문에 특정 회사 기술에 종속적이지 않다.
-   Blue-Green 배포
    -   애플리케이션을 업데이트하기 위해 컨테이너를 교체하는 방식 사용.
    -   WAS는 클래스 교체하다 실패하는 경우를 막아주게 된다.
    -   도커는 새로운 이미지로 새로운 컨테이너를 만드는 방식으로 사용하게 된다.

## 도커를 사용하는 이유

-   리빙포인트 : Bare Metal은 실제 존재하는 서버를 의미한다.
    -   법적으로 물리적인 제한을 두도록 하는 서비스에서 사용될 수 있다.
-   실제 운영 환경에서 물리적으로 서버를 나누어 사용했다.
    -   가상화를 통해 여러개의 서버를 한 서버에서 구동할 수 있게 되었다.
    -   특정 프로세스 하나가 죽으면 다같이 죽기 때문이다.
        -   가상머신에서는 제한 이상을 사용하기 때문에, 리소스가 격리되어 사용되게 된다.
    -   쿠버네티스를 컨테이너 오케스트레이션 도구로 쓸 수 있는 이유는, 컨테이너가 격리되어 있기 떄문이다.
    -   컨테이너는 안데 런타임 환경도 포함되어 있다.
-   수평 확장이 필요할 대, 실무에선, 컨테이너가 없으면 개빡세진다.
    -   인프라 단에서는 열량 설계를 밀도있게 해야 한다.
    -   컨테이너를 적용하면 필요한 런타임 환경과 소스코드를 모두 포함시켜 작동시킬 수 있다.
-   장점은 생각할땐 우리의 서비스 활동에서 어떠한 이득이 있을까를 생각해야 한다.
    -   도커는 프로세스 가상화에 초점을 맞추고, 라이브러리 포함한거밖에 없지만 존나 빠르다. 안 쓸 이유가 없다.
-   윈도우나 맥에서는 Hyper-V 바탕으로 작동하게 된다.
    -   이때 리눅스 커널이 담긴 리눅스 킷을 동작시키고, 도커 엔진과 QEMU를 이용해 동작시키게 된다.

# Underlying Technologies

-   chroot (change root directory)
    -   새로운 bash 쉘을 chroot로 실행하여 root를 바꿀 수 있다.
    -   이를 통해 권한을 조정할 수 있다.
-   cgroup (Control Groups)
    -   오작동을 하게 되면, 프로세스 별로 자원에 대한 제어를 가능하게 해준다.
    -   메모리, blockio, cpu, freezer, cpuset 등을 컨테이너 별로 제약을 걸 수 있게 된다.
    -   컨테이너는 언제든 죽을 수 있다는 관점에서 설계해야 한다.
        
-   Namespace
    -   chroot와 비슷한데, Namespace는 6가지를 지원하게 된다.
        -   Mount : 호스트 파일 시스템에 구애받지 않고 독립적으로 파일 시스템을 마운트할 수 있다.
        -   PID : 독립적인 프로세스 공간 할당
        -   Network : namespace간의 network 충돌을 방지한다. (중복 포트 바인딩 등)
        -   IPC : 프로세스간에 독립적인 통신 통로 할당
        -   Hostname : 독립적인 호스트네입 할당
        -   UID : 독립적인 사용자 할당
    -   이를 독립적으로 구성시킬 수 있다.

# Mechanism of Docker
-   도커를 사용할 때는 도커의 설치 경로를 잘 알아야 한다. 중요.
    -   하위 경로에 container가 있고, 여기로 로그와 데이터가 떨어지게 된다.
    -   image도 하위 폴더로 떨어진다.
        -   도커를 리눅스 부팅 영역 스토리지와 같이 써서 문제 생기는 경우가 있다.
    -   도커의 로그와 이미지, 컨테이너 등 사용할 용량을 설계해야 한다.
        -   표준화된 경로를 통해 사용해야 한다.
    -   도커 자체를 독립적으로 마운트해서 사용해야 한다는 것이다.
-   원격 VM에서 http, https 신호를 보내 도커 데몬을 제어할 수 있다.
    -   또는 ssh로 접속해서 사용할 수 있다.
    -   도커, 도커 컴포즈만 쓸땐, ssh로 직접 접속해서 하는게 낫다.
    -   이걸로 채굴하는 경우 많다.
-   이미지 기본 세팅은 도커 허브로 구성되어 있다.
    -   이미지는 오피셜 이미지를 웬만하면 쓰자.
        -   도커 이미지는 도커파일 공개 안하면, 악의적으로 포함된 이미지를 사용하게 될 수도 있다.
        -   버전을 태그로 지정해서 관리한다.
-   도커 외부와 컨테이너를 연결하기 위해서 도커는 새로운 네트워크 브릿지를 만들게 된다.
    -   이를 통해서 네트워크에 접근할 수 있도록 한다.
    -   또한, 포트포워딩 기술을 사용할 수 있다.
-   네트워크 성능이 떨어지면, 도커와 쿠버네티스 성능이 다 작살난다.
    -   여러 클러스터를 구성해서 사용하고, 리소스를 잘 쓰고 구성이 빨라도 네트워크가 느려지면 의미 없지만
    -   커널 단위로 포트포워딩과 네트워크 룰이 적용되어 빨라질 수 있게 된다.
        -   도커 설치하면 새로운 룰이 생기게 된다.
    -   ip table까지 볼 수 있어야 장애를 해결할 수 있게 된다.
-   도커만 사용할 때도 특정 링크를 이용해 도메인명처럼 컨테이너를 찾아갈 수 있는 기능을 제공한다.
-   새로운 어플리케이션을 고객의 요구를 받아 배포할 때 장애에서 롤백하는 기능이 빠르게 수행될 수 있다.
    -   접근성, 민첩성이 빨라지게 된다.
    -   다음 특강때 좀 더 자세히 araboza
-   도커파일 내에 우리가 필요한 코드들을 모두 작성해줘야 한다.