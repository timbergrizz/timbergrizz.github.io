---
title: K8s - Scheduling
feed: hide
---
## Scheduling
- Node들이 있을 때, 어떤 Node로 보낼 것인가?
	- 이를 결정하는 것이 스케줄링이다.
- Taint : admin
	- 여기로 오지 마라는 의미이다.
		- Taint 걸린 Node에는 Pod 배포하지 않는다.
	- 이게 Admin이고, 여기로 배포하려면 Toleration이 필요하다.
		- 이 Pod는 이 노드로 배포되는 것을 허가받았다.
		- key=value:effect 형식으로 정의된다.
	- Taint에는 3가지 effect가 있다.
		- noschedule
			- taint 처리 된 상태에서 pod 배포하려면 새로 배포해야 한다.
			- 이미 들어간 pod는 영향을 끼치지 않는다.
		- noexecute
			- 기존 pod 있어도 toleration 없으면 다 쫓아낸다.
			- 의도적으로 node를 비워야 할 때가 있다.
				- VM 점검할 때 이거 다른데로 다 보내야 할 때 이런거 사용하면 좋다.
				- 보통은 NoSchedule을 많이 사용한다.
- Node를 일반적으로 여러 타입을 섞는다.
	- Node Pool이라 하는데, Node를 여러 종류로 가진 클러스터를 배포할 수 있다.
		- 이거 적절한 컴퓨팅 성능에 배포될 수 있도록 배치를 해주어야 한다.

## Scheduler

### Node Affinity
- 노드가 3개 있을 때,  gpu 레이블과 cpu 레이블이 있을 때, pod에서 node affinity에 따라 매칭되는 노드로 올리도록 할 수 있다.
- nodeAntiAffinity는 레이블에 해당하지 않는 곳으로만 데이터를 보내게 된다.![[Pasted image 20221018142504.png]]
	- 여러개의 영역이 있을 때, 특정 영역에 배포될 수 있도록 하는데 자주 사용된다.
- soft affinity는 거기로 우선적으로 보내는 것이다.
	- 거기로 안 갈수도 있고, way값에 따라 결정될 수 있다.
		- 배포될 수 없으면 다른데로 간다.
- 실제로 배포하면, 이렇게 배포되지 않을 수 있다.
	- 쿠베의 스케줄러는 여러가지 스케줄링 매커니즘을 합산한 후 노드를 구하기 때문에 달라질 수 있다.
	- selector-SpreadPrority function이 있어, 여러 개의 node에 최대한 분포하고자 한다.
- topology 키를 따라 배포할 수 있다.
	- pod가 배포되어 있는 노드를 찾은 후, 여기로 배포가 되도록 할 수 있다.
- pod anti affinity를 통해 이미 있는 곳에는 배포하지 않도록 할 수 있다.
	- anti affinity를 확인하여 배포되지 않도록 설정할 수도 있다.
- 대단히 유용한 배포 기능이다.
	- 이를 사용하는지 여부에 따라 엔지니어의 수준이 결정될 수 있다.
	- 일반적인 엔지니어는 그냥 배포 갈기는데, 그렇게 써도 크게 문제는 안된다.
		- 근데 운영 상에서 몰리는 상황이 발생하지 않도록 하면, 가용성 등에서 이점을 볼 수 있다.
- 서버가 여러개 있을 때, pod를 배포했을 때 pod label와 topology key를 통해 여러 가용영역에 분포하여 보낼 수 있다.
	- 하나의 포드가 분리되어 배포되었을 때, 다른 포드를 같은 곳으로 붙이도록 구성할 수 있다.
	- affinity와 anti affinity를 같이 주어 하나씩만 배포되도록 할 수 있다.
		- 사실은 sidecar로 두개 묶어서 배포하면 된다.
		- 이렇게 할 일이 생기는 경우가 있다.
			- 개발의 주체에 따라 달라진다.
				- 다른 어플리케이션 서버일 때, 2개의 팀이 개발한 config를 하나에 묶는게 더 골때릴 수 있다.
				- 이런 경우는 affinity로 묶어서 따로 pod로 묶어서 배포하는 경우가 나을 수 있다.
		- pod의 권한 문제로 이렇게 배포해야 하는 경우도 생긴다.
			- kernal access의 여부에 따라 pod를 분리해야 한다.
				- security level에 따라서 pod가 분리 될 수 있도록 해야 한다.



