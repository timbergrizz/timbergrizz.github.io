---
title: K8s - Security
feed: hide
---

## Security
- user identity
	- 사람도 있지만 시스템도 유저로 본다.
		- 시스템 유저를 대표하는 것을 서비스 어카운트라 한다.
	- API에 대한 identification이 가능해야 한다.
		- service account를 identity로 준다.
- 쿠버네티스는 기본적으로 계정 관리 시스템이 없다.
	- 철저하게 id 관리 시스템을 외부 시스템을 사용하도록 한다.
	- packaging 서비스는 다 있다.
- service account를 인증을 걸도록 할 수 있다.

### Authentication
- 인증 방식이 중요하다.
	- 바닐라로 HTTP에 ID / Pass 넣으면 신난다.
	- 헤더에 넣어도 신난다.
	- 공인 인증서 방식을 사용하는 HTTPS 쓰는게 제일 좋다.
		- Certificate 방식으로 사용하는 것이 가장 안전하다.
		- 양방향 ssl 방식이라 안전하긴 하다.

### RBAC
- Resource Based Access Control
	- 각각의 pod에 Role에 따라 권한을 배치하는 방식이다.
	- role을 유저로 연결하는 방식이 role-binded가 된다.
- namespace
	- role은 namespace 내부에만 존재한다.
	- 롤을 만들면, tenant 안에만 존재한다.
		- 다른 namespace user한테 role 줄 수 있다.
		- 다른 프로젝트에 권한을 주어 접근 할 수 있도록 할 수 있다.
	- 운영 팀을 프로젝트에 있는 Role을 할당하도록 할 수 있다.

- 클러스터에 대한 Role을 부여할 수 있고, 이러한게 되게 많다.
	- 불편하게 하지 말라고 pre-defined role들이 있다.
		- 기존에 있는 pre-defined role 쓰는게 정신건강에 이롭다.

### Network Policy
- 방화벽!
- ingress등으로 들어오고 나가는 트래픽을 통제하는 것이다.
	- 보통은 ip로 컨트롤 하는데, 아웃바운드과 쿠베는 구분 가능한데, 쿠배 내부 서비스는 ip로 통제 안된다
		- 태그로 통제한다.
- 한번 해보시는게 제일 이해하기 편하다.
- port 단위 등으로 컨트롤 할 수 있다.
	- 레시피 있고, 이거 보는게 제일 좋다.
- 네트워크 정책 별로 쓸 필요 없다.
	- 인그레스 앞에 붙고, 내부 서비스 붙은 뒤에 pod로 이어지는 패턴이다.
		- L7 로드밸런서이기 때문에 ingress에서 방화벽 기능이 이미 존재하고, 내부 트래픽을 컨트롤할 일이 잘 없다.
		- 금융 요건 따르기 위해서 api 서버 / db 서버를 분리하도록 할 수는 있긴 하고, multi-tenancy에서 사용할 수 있다.
			- 통신 장비는 요즘 다 사실 소프트웨어 장비로 나온다.
				- 쿠버네티스 클러스터로 나오도록 할 수 있따.
- 알아만 두자.

### Security Context
- Pod가 돌 때 어떻게 작동시킬건지를 설정한다.
	- 도커파일 만들 때 run 시키는데, root 권한이 아닌 다른 user 권한으로 작동시키도록 하는 것이 좋다.
	- 다른 사람이 컨테이너 들어왔을 때 사고 안나도록 하려고 root로 동작하지 않도록 하면 좋다.
		- 어플리케이션에서 root 를 필요로 하면 튕겨버린다.
- kernal에 대한 접근 권한을 줄 수도 있다.
	- default는 커널 접근 가능하도록 하는 것이다.
		- 시스템 콜들을 막아 커널을 보호하도록 할 수도 있다.
		- app에서 노드에, vm에, 호스트에 권한을 막을 수 있다.
		- privileage등의 권한을 막도록 하여 설정할 수 있다.
		- 특정한 권한만 가질 수 있도록도 설정할 수 있다.
- 어플리케이션은 보통 개발자가 만든다.
	- Pod도 개발자가 같이 만들기 때문에, 커널 권한을 직접 요청할 수 있다.
	- 운영자 입장에선 권한을 주지 않을 수 있고, 쿠버네티스에서 보안 정책을 설정할 수 있다.
		- SRE가 줘서 커널 권한 접근을 못하도록 막는다.

### Pod Security Policy
- Privilege model을 접근하지 못하도록 막는 것이다.
	- 권한을 요청해도 막히게 된다.
	- 중앙 admin이 security policy를 만들어, 각 pod에 배포하는 방식으로 작동시킬 수 있다.

- 사실 별로 쓸 일은 없다.
	- root 권한 주는것도 별로다.
- 지금의 케이스는 결국 굉장히 중요한 보안 수준을 필요로 하는 경우이다.
	- [gVisor](https://gvisor.dev/)라는게 요즘 나와서 커널 분리하는 솔루션들이 있다.
		- kvm이라는걸 달아서 시스템 콜만 캐치할 수 있도록 한다.
		- 샌드박스 내부에서 동작할 수 있도록 할 수 있다.
	- 일종의 얇은 vm 레이어를 넣었다고 볼 수 있다.

- 마스터 노드 있고, 하단에 노드들이 붙을 때 마스터에 대한 ip 제어를 하는 것이 좋다.
	- 특정 대역폭에서만 접근할 수 있도록 방화벽을 세팅하는 것이 좋다.
	- 노드들은 public ip를 갖지 않는 것이 좋다.
- 밖에서 들어오는 트래픽은 service와 ingress를 통해서만 받도록 해야 한다.
- kubectl 있을때, certification으로 인증하는데, cert를 주기적으로 rotate해주는 것이 좋다.
	- fido key라는게 있고, 이거 찾아서 만들 수 있다.
		- 여기에 ip 인증 시스템을 등록해서 작동하도록 할 수 있다.
		- 등록된 디바이스에 키를 넣고 접근해야 접근할 수 있도록 할 수 있다.
	- 보안은 사실 사람 못막으면 못막는다.