---
title: K8s - Continuous Integration and Deployment
feed: hide
---
## CI / CD

- ArgoCD 쓰시는게 답입니다.
	- Continuous Integration : 코드 빌드가 자동적으로 이루어지는 것
	- Continuous Deployment : 자동으로 서비스로의 deployment가 이루어진다.
		- Delivery와는 사람의 개입 여부로 달라지게 된다. 
			- Delivery는 사람의 개입이 필요로 한다.
		- 코드가 자동으로 deployment되는것이 당연히 좋긴 한데, 소프트웨어 자체가 비즈니스이고, 결제가 필요한 경우가 있으므로 사람의 개입이 필요한 경우가 많다.
- System에 배포하기 위한 방법
	1. 하드웨어 : VM, 네트워크, 스토리지 등
	2. 미들웨어 : DB, Message Queue
	3. 소프트웨어 : 서비스.
		- 서비스는 다른 경우와 다르게 변경되는 경우가 많다.
- 인프라를 배포하는 것은, Terraform으로 이루어진다.
- DB / 미들웨어 배포는 보통 ansible로 일반적으로 배포된다.
	- 쿠버네티스 환경이 오면서 달라지게 된다.
		- 인프라는 리소스이고, pod라는 서비스가 되므로 helm이라는 것을 많이 사용하게 된다.
		- 리소스를 배포할 수 있는 기능이 생겨 인프라, 미들웨어를 배포하는 것도 helm을 주로 사용하게 된다.
- scaffold, argocd를 주로 사용하여 서비스에 대한 배포가 이루어지게 된다.

- 동일한 문서라고 해도, 지역에 따라 달라지게 된다.
	- 쿠버네티스 리소스에 대해 템플릿을 만들고, 이에 대한 yaml을 만들어내야 한다.
	- helm이 이러한 개념을 사용한다.

### Helm
- 이렇게 변수화 시켜서 아키텍처를 만들 수 있도록 한 것이다.![[Pasted image 20221025142306.png]]
	- 일종의 템플릿을 제공한다고 볼 수 있다.
	- 이러한 아키텍처에 대해 패키지화를 할 수 있다.
- 서비스간의 dependency를 갖는 경우가 있다.
	- 이러한 dependency도 명시하여 쿠버네티스에 작동시킬 수 있다.
	- 엄청 많이 쓴다.

- Helm 파일은 다음과 같이 구성된다.![[Pasted image 20221025142453.png]]
	- helm tiller가 예전엔 필요했는데 지금은 상관 없다.
- templete based package manager이다.
	- helm을 통해 한번에 올리고, 내리기 편해진다.
	- install hook 등을 가질 수 있다.
		- 인스톨 후에 실행 시킬 수 있는 것들을 hook을 통해 가능하게 할 수 있다.
- 개발 환경 표준에 helm 사용하면 편하다.
	- mysql같은거 쿠베한테 할 수 있게 차트 만들어주면 좋다.
- Helm은 좀 배워두세요

### CI
- jar 파일을 깃허브에 그대로 넣는건 권장하지 않는다.
- 대기업에서는 static analytics, open source analysis등을 사용하게 된다.
	- 소스 코드의 복잡도를 분석하고, 오픈 소스의 라이센스를 체크하는데 도움을 준다.
- 젠킨스는 CD 호소인이다.
	- 되긴 한데, 웬만하면 CI / CD툴은 분리해서 사용하는 것이 좋다.
	- CI는 물리적인 location이 분리되도록 하는 것이 좋다.
		- Enterprise는 소스 코드를 외부로 웬만하면 반출하지 않는다
			- CI는 회사 내부에서 일어나고, CD툴로 연동하여 밖으로 보내주게 된다.
- 눈송이는 같은게 하나도 없다.
	- 서버도 동일한게 하나도 없다.
		- 이걸 최대한 동일하게 세팅할 수 있도록 해야 한다.
		- 서버의 형상이 모두 달라지게 되는 패턴을 스노우 플레이크 패턴이라고 한다.
			- 이거 굉장히 문제가 될 수 있는 패턴이다.
	- 요즘같은 서비스는 수동으로 매니지먼트 할 수 없고, 스노우 플레이크 패턴이 발생한다.
		- 피닉스 패턴이라고 하는데, 죽으면 다시 태어난다.
			- 피닉스 서버 패턴은 쿠버네티스 나오기 전에 나왔다.
			- binary만 replace하는 것이 아닌, os부터 새롭게 다 배포하도록 하는 개념이다.
		- 배포 할 때 마다 인프라부터 미들웨어, 서비스가 패킹되기 때문에 달라지지 않는다.
- 컨테이너로 오면서 base image를 넣고, 피닉스 패턴이 자연스럽게 쿠버네티스 패턴으로 이루어지게 된다.
	- 일정한 상태의 바이너리를 만들 수 있게 된다.

### CD
- 자바면 jar 빌드하고, 컨테이너면 태그 바꾸고, 레포로 푸쉬하고, yaml 업데이트하고, dev env로 배포하고, 테스트 / 디버깅 한다.
	- 직접하면 복잡해서 못한다.
	- 클라우드 코드 쓰니까 지금은 편한데, 다른거 쓰면 좀 골때린다.
- Skaffold가 구글에서 만든 미니 cd 툴인데, 이러한 cd 파이프라인을 구성해준다.
	- 레포지토리에 소스코드 변화 발생하면 build하고 이를 올려주고, 올려서 따로 필요한 작업까지 다 해준다.
	- helm이 되고, kustomize되서 좋다.
		- kustomize는 configuration management tool이다.
			- helm이랑 비슷한데, 이건 일반적인 템플릿 매니저다.
	- skaffold는 프로파일 개념으로 작동시킬 수 있고, 상황에 따라 다르게 CD가 이루어지도록 설정할 수 있다.![[Pasted image 20221025144011.png]]
	- yaml 파일 예시![[Pasted image 20221025144051.png]]
	- skaffold는 plugable 아키텍처이다.
		- helm과 같이 사용하면 좋다.
			- skaffold는 버전이나 롤백이 아니고, helm은 빌드하고 배포하지는 않는다.
				- 두개를 같이 사용하는 것이 좋다.
		- 요즘은 argo쪽으로 정리되는 것 같다.
	- MSA는 배포 많이 하게 되고, skaffold로 배포하게 되면 신나게 되는거다.
		- tekton이라는게 나왔다.
			- 파이프라인의 각 프레임마다 레이블을 하도록 했지만, 성공하지는 못했다.
- argocd가 인터페이스가 잘 되어있고, 편해서 성공했다.
- 배포에는 여러가지 방식이 존재하고, CD툴도 이를 지원해주어야 한다.
	- Spinnaker라는 툴이 이러한 역할을 한다.
		- argocd의 advanced된 툴이라고 할 수 있다.
		- CD 파이프라인을 만들고, exectution 원하는 시간에 이루어질 수 있도록 한다.
		- 문서가 업데이트가 잘 안된다.
		- 그래도 툴 자체는 되게 좋다.
			- 삼성전자랑 샌드버드가 잘한다.
		- 시스템 규모가 크고 하면 러닝커브 높아도 써볼만한 툴이다.
- 클라우드 코드는 쓰고 있죠?
	- 무조건 쓰세요.
- kubernetes operator 찾아보세요.
	- 쿠버네티스 보면 deployment등 리소스를 정의하도록 할 수 있다.
	- saas등에서 많이 사용한다.
		- 여러개 정의하는 걸 하나로 abstract해준다.
		- 코드를 짜주는게 복잡하고, Golang으로 짜는데 요즘은 [kopf](https://github.com/nolar/kopf)라는거 많이 쓰더라.
	- helm은 꼭 보세요.
- CD를 고민할 때, 클라우드 빌드로 이루어지게 된다.
	- 빌드 자체도 자원을 많이 요구하고, jenkins job을 여러개 두고 인스턴스 크기가 점점 커진다.
	- maker 하나만 도는게 아니라 유닛 테스트까지 돌면 인스턴스 크기가 감당이 안된다.
		- 빌드 머신이 점점 커지게 되고, 한 빌드가 점점 많아지게 된다.
		- 클러스터 유지하는 것도 일이다.
	- 클라우드에 매니지드 서비스로 얹고 이거 클라우드에 돌도록 할 수 있다.
	- 아니면 젠킨스x같은거 써서 쿠버네티스에 job으로 띄우던가...
		- 작은 시스템은 vm 한두대 돌리면 되는데 msa로 나가고 시스템 규모 커지면 분산 시스템 만들어줘야 하는 거다.
		- 클라우드 쓰는게 짱이다.
			- 자원 관리 이쪽에서 알아서 다 해준다.
	- 빌드 과정에서도 재미있는 practice가 많다.
		- 빌드 박살나면 패널티를 주고, 패널티 높아지면 배포 전에 리뷰하는 등의 패널티를 준다.
			- 볼게 되게 많고, SRE의 한 분야로 점점 더 중요해지고 있다.